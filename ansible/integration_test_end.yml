# Stop system under test

- hosts: pipeline_data_generator
  tasks:
    - name: check if efu data generator finished
      async_status:
        jid: "{{ efu_generator.ansible_job_id }}"
      register: efu_generator_result
      until: efu_generator_result.finished
      retries: "{{ integration_test_num_retries }}"
      ignore_errors: yes

    - name: print efu data generator stdout
      debug:
        msg: "{{ efu_generator_result.stdout_lines }}"

    - name: print efu data generator stderr
      debug:
        msg: "{{ efu_generator_result.stderr_lines }}"

- hosts: test_orchestrator
  tasks:
    - name: check if file writer command finished
      async_status:
        jid: "{{ file_writer_command.ansible_job_id }}"
      register: file_writer_command_result
      until: file_writer_command_result.finished
      retries: "{{ integration_test_num_retries }}"
      ignore_errors: yes

    - name: print file writer command stdout
      debug:
        msg: "{{ file_writer_command_result.stdout_lines }}"

    - name: print file writer command stderr
      debug:
        msg: "{{ file_writer_command_result.stderr_lines }}"

- hosts: efu
  tasks:
    - name: wait for pipeline to finish processing data
      pause:
        seconds: 5

    - name: check efu pipeline for correct counter values
      shell: "{{ event_formation_unit_base_dir }}/event-formation-unit/util/efushell/verifymetrics.py {{ integration_test_efu_metrics_verification_string }}"
      register: efu_pipeline_counters_result
      ignore_errors: yes

    - name: print efu pipeline counter check stdout
      debug:
        msg: "{{ efu_pipeline_counters_result.stdout_lines }}"

    - name: print efu pipeline counter check stderr
      debug:
        msg: "{{ efu_pipeline_counters_result.stderr_lines }}"
